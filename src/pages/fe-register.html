<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="../../resrc/images/icons/favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="../styles/common.css" />
    <link rel="stylesheet" href="../styles/authentication.css" />
    <title>Fashion Euphoria | Registeration Form</title>
    <style>
        #formSection {
            overflow-y: hidden;
            margin: 10px;
        }

        #feForm {
            padding: 10px;
            width: calc(100% - 30px);
        }

        #feForm p {
            font-size: 14px;
            text-align: left;
            color: #d8d8d8;
            margin-bottom: 10px;
            overflow-y: hidden;
        }

        #feForm h3 {
            border-bottom: 1px solid #383838;
            padding-bottom: 10px;
            width: calc(100% + 20px);
            margin-left: -10px;
        }

        .form-step {
            flex-direction: column;
            justify-content: space-between;
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .form-step.active {
            min-height: calc(100vh - 280px);
            display: flex;
            opacity: 1;
        }

        .checks {
            width: calc(100% - 20px);
            font-size: 14px;
            padding: 10px;
            color: #9e9e9e;
            border: 1px solid #383838;
            border-radius: 10px;
            background-color: #1a1a1aa1;
            margin: 0px auto 10px auto;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            display: none;
            /* hide default checkbox */
        }

        .checkbox-group label {
            display: inline-block;
            padding: 5px 10px;
            border: 1px solid #383838;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        /* Checked state */
        .checkbox-group input[type="checkbox"]:checked+label {
            background-color: rgba(0, 251, 255, 0.096);
            color: rgb(0, 255, 200);
            border-color: rgba(0, 255, 208, 0.575);
        }

        /* Hidden text input */
        .other-input {
            max-height: 0;
            opacity: 0;
            width: calc(100% - 22px);
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .other-input input {
            margin-top: 7px;
            width: 100%;
            outline: none;
            transition: box-shadow 0.3s ease;
        }

        /* Show animation when "Other" is checked */
        #Other:checked~.other-input {
            max-height: 70px;
            opacity: 1;
            transform: translateY(0);
        }

        select {
            color: grey;
            margin-bottom: 10px;
            padding: 9px;
        }

        option {
            color: grey;
            background-color: black;
            font-size: 15px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        #qr {
            width: 70%;
            border-radius: 7px;
            margin-bottom: 10px;
        }

        #login-btn {
            color: white;
            text-decoration: none;
            border: 1px solid #383838;
            padding: 10px 20px;
            border-radius: 7px;
            background-color: #0c0c0c;
        }

        .iti {
            width: 100%;
        }

        #tshirts {
            margin: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #tshirts img {
            border: 1px sold #383838;
            width: 100%;
            max-width: 210px;
            border-radius: 10px;
            border: 1px solid #383838;
        }

        #progressWrap {
            width: 100%;
            background-color: #1a1a1a;
            border-radius: 7px;
            margin-bottom: 20px;
            margin-top: -20px;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <section id="formSection">
        <canvas id="gradientCanvas"></canvas>

        <form id="feForm" onsubmit="handleButtonAction('submit','Submitting','Submitted',()=>handleFormSubmit(event))">

            <h3>Fashion Euphoria 2026</h3>
            <!--<div id="progressWrap">
                <div id="progressBar" style="height: 2px; background-color: aqua;"></div>
            </div>-->

            <!-- STEP 1 : COMPETITION -->
            <div class="form-step active" id="step1">
                <div class="inputs">
                    <p>Step into the spotlight and showcase your style and creativity at <b>Fashion Euphoria 2026</b>!
                        <br>Register below to participate in the <U><b>Fashion</b></U> or <U><b>Cosplay</b></U>
                        competition. <br><br><b>‚ö†Ô∏èNOTE:</b> Please ensure all details provided are accurate, as they
                        will be used for event coordination and participant communication.</p>
                    <div class="checks">
                        <div class="checkbox-group">
                            <a href="privacy-policy.html">Terms & Conditions</a>
                            <input type="checkbox" id="agree_tc" />
                            I agree to the Terms & Conditions *
                            <label for="agree_tc">Yes
                            </label>
                        </div>
                    </div>
                    <select id="competition" required>
                        <option value="" disabled selected>Competition *</option>
                        <option value="fashion">Fashion</option>
                        <option value="cosplay">Cosplay</option>
                    </select>
                </div>
                <div class="btn-group">
                    <span></span>
                    <button type="button" class="long-btn" onclick="nextStep(1)">Next</button>
                </div>
            </div>

            <!-- STEP 2 : CATEGORY -->
            <div class="form-step" id="step2">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>No. of Members</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Solo</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td>Duet</td>
                            <td>2</td>
                        </tr>
                        <tr>
                            <td>Group</td>
                            <td>3-12</td>
                        </tr>
                    </tbody>
                </table>
                <div class="inputs">
                    <select id="category" required>
                        <option value="" disabled selected>Category *</option>
                        <option value="solo">Solo</option>
                        <option value="duet">Duet</option>
                        <option value="group">Group (Fashion only)</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevStep(2)">Previous</button>
                    <button type="button" class="long-btn" onclick="nextDynamic()">Next</button>
                </div>
            </div>

            <!-- STEP 3 : MEMBER 1 / SOLO / POC -->
            <div class="form-step" id="step3">
                <div class="inputs">
                    <input type="text" id="m1_name" name="m1_name" placeholder="Name *" required />
                    <select id="m1_gender" name="m1_gender" required>
                        <option value="" disabled selected>Gender *</option>
                        <option>Male</option>
                        <option>Female</option>
                        <option>Other</option>
                    </select>

                    <div class="checks">
                        <p>DOB</p><input type="date" id="m1_dob" name="m1_dob" required />
                    </div>
                    <input type="tel" id="m1_phone" name="m1_phone" placeholder="Phone Number *" required />
                    <input type="tel" id="m1_alt_phone" name="m1_alt_phone" placeholder="Alternate Phone Number" />
                    <input type="email" id="m1_email" name="m1_email" placeholder="Email *" required />
                    <input type="text" id="m1_college" name="m1_college" placeholder="College Name *" required />
                </div>
                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevDynamic()">Previous</button>
                    <button type="button" class="long-btn" onclick="nextDynamic()">Next</button>
                </div>
            </div>

            <!-- STEP 4 : MEMBER 2 (DUET) -->
            <div class="form-step" id="step4">
                <div class="inputs">
                    <input type="text" id="m2_name" name="m2_name" placeholder="Member 2 Name *" required />
                    <select id="m2_gender" name="m2_gender" required>
                        <option value="" disabled selected>Gender *</option>
                        <option>Male</option>
                        <option>Female</option>
                        <option>Other</option>
                    </select>
                    <input type="date" id="m2_dob" name="m2_dob" required />
                    <input type="tel" id="m2_phone" name="m2_phone" placeholder="Phone Number *" required />
                    <input type="email" id="m2_email" name="m2_email" placeholder="Email *" required />
                    <input type="text" id="m2_college" name="m2_college" placeholder="College Name *" required />
                </div>
                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevDynamic()">Previous</button>
                    <button type="button" class="long-btn" onclick="nextDynamic()">Next</button>
                </div>
            </div>

            <!-- STEP 5 : GROUP INFO -->
            <div class="form-step" id="step5">
                <div class="inputs">
                    <div class="checks">
                        <p>Number of Members (3-12) *</p>
                        <div class="checkbox-group">
                            <script>
                                for (let i = 3; i <= 12; i++) {
                                    document.write(
                                        `<input type="checkbox" name="group_size" id="g${i}" value="${i}">
                 <label for="g${i}">${i}</label>`
                                    )
                                }
                            </script>
                        </div>
                    </div>
                    <textarea id="group_members" name="group_members"
                        placeholder="Names of all members (comma separated) *" required></textarea>
                </div>
                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevDynamic()">Previous</button>
                    <button type="button" class="long-btn" onclick="nextDynamic()">Next</button>
                </div>
            </div>

            <div class="form-step" id="stepFinal">
                <div class="inputs">
                    <p>üéâ You're almost done!</p>
                    <p>Join our official WhatsApp community for updates & coordination:</p>

                    <a href="https://chat.whatsapp.com/YOUR_COMMUNITY_LINK" target="_blank" class="long-btn">
                        Join WhatsApp Community
                    </a><br>
                    <div class="checks">
                        <div class="checkbox-group">
                            <input type="checkbox" id="joined_wa" />
                            I have joined the WhatsApp community *
                            <label for="joined_wa">Yes
                            </label>
                        </div>
                    </div>


                    <p style="margin-top:10px">
                        Make sure all details are correct before submitting.
                    </p>
                </div>

                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevDynamic()">Previous</button>
                    <button type="submit" class="long-btn" id="submit">Submit</button>
                </div>
            </div>


        </form>


    </section>
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <img id="modal-image" />
        </div>
    </div>
    <script src="../scripts/common.js"></script>
    <script src="../scripts/authentication.js"></script>
    <script>
        // ----------------------------
        // STATE
        // ----------------------------
        let flow = []
        let flowIndex = 0
        const STORAGE_KEY = "malang_fe_register"

        // ----------------------------
        // PROGRESS BAR
        // ----------------------------
        function updateProgress() {
            const bar = document.getElementById("progressBar")
            if (!bar || !flow.length) return
            const percent = ((flowIndex + 1) / flow.length) * 100
            bar.style.width = percent + "%"
        }

        // ----------------------------
        // SHOW STEP
        // ----------------------------
        function showStep(step) {
            document.querySelectorAll(".form-step")
                .forEach(s => s.classList.remove("active"))

            const el = document.getElementById(`step${step}`)
            if (!el) return

            el.classList.add("active")
            updateProgress()
            window.scrollTo({ top: 0, behavior: "smooth" })
        }

        // ----------------------------
        // VALIDATION
        // ----------------------------
        function validateStep(step) {
            let valid = true

            const required = {
                1: ["competition"],
                2: ["category"],
                3: [
                    "m1_name", "m1_gender", "m1_dob", "m1_phone",
                    "m1_email", "m1_college"
                ],
                4: [
                    "m2_name", "m2_gender", "m2_dob", "m2_phone",
                    "m2_email", "m2_college"
                ],
                5: ["group_members"]
            }

            if (required[step]) {
                required[step].forEach(id => {
                    const el = document.getElementById(id)
                    if (!el || !el.value.trim()) valid = false
                })
            }

            // STEP 1: Terms & Conditions
            if (step === 1) {
                const tc = document.getElementById("agree_tc")
                if (!tc || !tc.checked) valid = false
            }

            // STEP 5: Group size
            if (step === 5) {
                if (
                    document.querySelectorAll("input[name='group_size']:checked").length === 0
                ) valid = false
            }

            // FINAL STEP: WhatsApp joined
            if (step === "Final") {
                const wa = document.getElementById("joined_wa")
                if (!wa || !wa.checked) valid = false
            }

            if (!valid) {
                showAlert(
                    "‚ö†Ô∏è",
                    "Please complete all required confirmations before continuing.",
                    [{ text: "OK" }]
                )
            }

            return valid
        }


        // ----------------------------
        // BUILD FLOW
        // ----------------------------
        function buildFlow() {
            const comp = competition.value
            const cat = category.value

            flow = [1, 2, 3]

            if (cat === "duet") flow.push(4)
            if (cat === "group" && comp === "fashion") flow.push(5)

            flow.push("Final")

            flowIndex = 2
            showStep(flow[flowIndex])
        }

        // ----------------------------
        // NAVIGATION
        // ----------------------------
        function nextStep(step) {
            if (validateStep(step)) showStep(step + 1)
        }
        function prevStep(step) { showStep(step - 1); }

        function nextDynamic() {
            if (document.getElementById("step2").classList.contains("active")) {
                if (!validateStep(2)) return
                buildFlow()
                return
            }

            if (!validateStep(flow[flowIndex])) return

            flowIndex++
            showStep(flow[flowIndex])
        }

        function prevDynamic() {
            if (flowIndex > 0) {
                flowIndex--
                showStep(flow[flowIndex])
            }
        }

        // ----------------------------
        // DISABLE GROUP FOR COSPLAY
        // ----------------------------
        competition.addEventListener("change", e => {
            const g = [...category.options].find(o => o.value === "group")
            if (g) g.disabled = e.target.value === "cosplay"
        })

        // ----------------------------
        // AUTOSAVE (EVERY INPUT)
        // ----------------------------
        const form = document.getElementById("feForm")

        function saveForm() {
            const data = {}
            new FormData(form).forEach((v, k) => data[k] = v)
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
        }

        function restoreForm() {
            const saved = localStorage.getItem(STORAGE_KEY)
            if (!saved) return

            const data = JSON.parse(saved)
            Object.keys(data).forEach(k => {
                const el = form.elements[k]
                if (!el) return

                if (el.type === "checkbox") {
                    el.checked = true
                } else {
                    el.value = data[k]
                }
            })
        }

        form.addEventListener("input", saveForm)
        window.addEventListener("load", restoreForm)

        // ----------------------------
        // SINGLE SELECT CHECKBOX GROUPS
        // ----------------------------
        document.querySelectorAll(".checkbox-group").forEach((group) => {
            const checkboxes = group.querySelectorAll("input[type='checkbox']");
            checkboxes.forEach((box) => {
                box.addEventListener("change", () => {
                    if (box.checked) {
                        checkboxes.forEach((other) => {
                            if (other !== box) other.checked = false;
                        });
                    }
                });
            });
        });
        // ----------------------------
        // FORM SUBMIT (UNCHANGED + CLEAR STORAGE)
        // ----------------------------
        async function handleFormSubmit(e) {
            e.preventDefault()

            const url =
                "https://script.google.com/macros/s/AKfycbwf8Oxhfg-Pwj0R--A7zoffnEvRr8K0LA_npx_C9ivq0f9J4RH4AaJRY3VFH3wgoK3Pxg/exec"

            const formData = new FormData(form)

            let base64File = ""
            let fileName = ""
            const fileInput = document.getElementById("screenshot")

            if (fileInput && fileInput.files.length) {
                const file = fileInput.files[0]
                fileName = file.name
                base64File = await toBase64(file)
            }

            const data = Object.fromEntries(formData.entries())
            data.fileData = base64File
            data.fileName = fileName

            try {
                await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                    mode: "no-cors"
                })

                localStorage.removeItem(STORAGE_KEY)

                showAlert(
                    "Submitted!",
                    "Your registration is complete üéâ",
                    [{ text: "Awesome!" }]
                )

                confetti()
                form.reset()
                showStep(1)
            } catch (err) {
                showAlert("‚ùå Error", "Please try again later.", [{ text: "OK" }])
            }
        }

        function toBase64(file) {
            return new Promise((res, rej) => {
                const r = new FileReader()
                r.readAsDataURL(file)
                r.onload = () => res(r.result.split(",")[1])
                r.onerror = rej
            })
        }
    </script>

</body>