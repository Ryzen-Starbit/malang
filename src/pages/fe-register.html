<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="../../resrc/images/icons/favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="../styles/common.css" />
    <link rel="stylesheet" href="../styles/authentication.css" />
    <title>Fashion Euphoria | Registeration Form</title>
    <style>
        #formSection {
            overflow-y: hidden;
            margin: 10px;
        }

        #feForm {
            padding: 10px;
            width: calc(100% - 30px);
        }

        #feForm p {
            text-align: left;
            color: #d8d8d8;
            margin-bottom: 10px;
            overflow-y: hidden;
        }

        #feForm h3 {
            border-bottom: 1px solid #383838;
            padding-bottom: 10px;
            width: calc(100% + 20px);
            margin-left: -10px;
        }

        .form-step {
            flex-direction: column;
            justify-content: space-between;
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .form-step.active {
            min-height: calc(100vh - 280px);
            display: flex;
            opacity: 1;
        }

        .checks {
            width: calc(100% - 20px);
            font-size: 14px;
            padding: 10px;
            color: #9e9e9e;
            border: 1px solid #383838;
            border-radius: 10px;
            background-color: #1a1a1aa1;
            margin: 0px auto 10px auto;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            text-align: left;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            display: none;
            /* hide default checkbox */
        }

        .checkbox-group label {
            display: inline-block;
            padding: 5px 10px;
            border: 1px solid #383838;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        /* Checked state */
        .checkbox-group input[type="checkbox"]:checked+label {
            background-color: rgba(0, 251, 255, 0.096);
            color: rgb(0, 255, 200);
            border-color: rgba(0, 255, 208, 0.575);
        }

        /* Hidden text input */
        .other-input {
            max-height: 0;
            opacity: 0;
            width: calc(100% - 22px);
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .other-input input {
            margin-top: 7px;
            width: 100%;
            outline: none;
            transition: box-shadow 0.3s ease;
        }

        /* Show animation when "Other" is checked */
        #Other:checked~.other-input {
            max-height: 70px;
            opacity: 1;
            transform: translateY(0);
        }

        select {
            color: grey;
            margin-bottom: 10px;
            padding: 9px;
        }

        option {
            color: grey;
            background-color: black;
            font-size: 15px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        #qr {
            width: 70%;
            border-radius: 7px;
            margin-bottom: 10px;
        }

        #login-btn {
            color: white;
            text-decoration: none;
            border: 1px solid #383838;
            padding: 10px 20px;
            border-radius: 7px;
            background-color: #0c0c0c;
        }

        .iti {
            width: 100%;
        }

        #tshirts {
            margin: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #tshirts img {
            border: 1px sold #383838;
            width: 100%;
            max-width: 210px;
            border-radius: 10px;
            border: 1px solid #383838;
        }

        #progressWrap {
            width: 100%;
            background-color: #1a1a1a;
            border-radius: 7px;
            margin-bottom: 20px;
            margin-top: -20px;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <section id="formSection">
        <canvas id="gradientCanvas"></canvas>

        <form id="feForm"
            onsubmit="handleButtonAction('submit','Registering','Registered',()=>handleFormSubmit(event))">

            <h3>Fashion Euphoria 2026</h3>
            <!--<div id="progressWrap">
                <div id="progressBar" style="height: 2px; background-color: aqua;"></div>
            </div>-->

            <!-- STEP 1 : COMPETITION -->
            <div class="form-step active" id="step1">
                <div class="inputs">
                    <p>Step into the spotlight and showcase your style and creativity at <b>Fashion Euphoria 2026</b>!
                        <br>Register below to participate in the <U><b>Fashion</b></U> or <U><b>Cosplay</b></U>
                        competition. <br>
                        <div class="checks">
                        <div class="checkbox-group">
                            <p style="margin-bottom:0px;">Checkout the<a href="https://drive.google.com/file/d/1EzZTyW7O_Jq05KfaF7BIo1VmW0P_Y3wt/view?usp=drivesdk"> Event Rulebook</a> before registering.</p>
                        </div>
                    </div>
                    <div class="checks">
                        <div class="checkbox-group">
                            <p>I agree to the <a href="terms.html">Terms</a> & <a href="privacy-policy.html">Privacy
                                    Policy</a> *</p>
                            <input type="checkbox" id="agree_tc" />
                            <label for="agree_tc">Yes
                            </label>
                        </div>
                    </div>
                    <select id="competition" name="competition" required>
                        <option value="" disabled selected>Competition *</option>
                        <option value="fashion">Fashion</option>
                        <option value="cosplay">Cosplay</option>
                    </select>
                </div>
                <div class="btn-group">
                    <span></span>
                    <button type="button" class="long-btn" onclick="nextStep(1)">Next</button>
                </div>
            </div>

            <!-- STEP 2 : CATEGORY -->
            <div class="form-step" id="step2">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>No. of Members</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Solo</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td>Duet</td>
                            <td>2</td>
                        </tr>
                        <tr>
                            <td>Group</td>
                            <td>3-12</td>
                        </tr>
                    </tbody>
                </table>
                <div class="inputs">
                    <select id="category" name="category" required>
                        <option value="" disabled selected>Category *</option>
                        <option value="solo">Solo</option>
                        <option value="duet">Duet</option>
                        <option value="group">Group (Fashion only)</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevStep(2)">Previous</button>
                    <button type="button" class="long-btn" onclick="nextDynamic()">Next</button>
                </div>
            </div>

            <!-- STEP 3 : MEMBER 1 / SOLO / POC -->
            <div class="form-step" id="step3">
                <div class="inputs">
                    <input type="text" id="poc_name" name="poc_name" placeholder="Full Name *" required />
                    <select id="poc_gender" name="poc_gender" required>
                        <option value="" disabled selected>Gender *</option>
                        <option>Male</option>
                        <option>Female</option>
                        <option>Other</option>
                    </select>

                    <div class="checks">
                        <p>DOB *</p><input type="date" id="poc_dob" name="poc_dob" required />
                    </div>
                    <input type="tel" id="poc_phone" name="poc_phone" placeholder="Phone Number *" required />
                    <input type="tel" id="poc_alt_phone" name="poc_alt_phone" placeholder="Alternate Phone Number" />
                    <input type="email" id="poc_email" name="poc_email" placeholder="Email *" required />
                    <input type="text" id="poc_college" name="poc_college" placeholder="College Name *" required />
                </div>
                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevDynamic()">Previous</button>
                    <button type="button" class="long-btn" onclick="nextDynamic()">Next</button>
                </div>
            </div>

            <!-- STEP 4 : MEMBER 2 (DUET) -->
            <div class="form-step" id="step4">
                <div class="inputs">
                    <input type="text" id="m2_name" name="m2_name" placeholder="Full Name (2nd Member) *" required />
                    <select id="m2_gender" name="m2_gender" required>
                        <option value="" disabled selected>Gender *</option>
                        <option>Male</option>
                        <option>Female</option>
                        <option>Other</option>
                    </select><div class="checks">
                        <p>DOB *</p><input type="date" id="m2_dob" name="m2_dob" required />
                    </div>
                    <input type="tel" id="m2_phone" name="m2_phone" placeholder="Phone Number *" required />
                    <input type="email" id="m2_email" name="m2_email" placeholder="Email *" required />
                    <input type="text" id="m2_college" name="m2_college" placeholder="College Name *" required />
                </div>
                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevDynamic()">Previous</button>
                    <button type="button" class="long-btn" onclick="nextDynamic()">Next</button>
                </div>
            </div>

            <!-- STEP 5 : GROUP INFO -->
            <div class="form-step" id="step5">
                <div class="inputs">
                    <div class="checks">
                        <p>Number of Members (3-12) *</p>
                        <div class="checkbox-group">
                            <script>
                                for (let i = 3; i <= 12; i++) {
                                    document.write(
                                        `<input type="checkbox" name="group_size" id="g${i}" value="${i}">
                 <label for="g${i}">${i}</label>`
                                    )
                                }
                            </script>
                        </div>
                    </div>
                    <textarea id="group_members" name="group_members"
                        placeholder="Names of all members (comma separated) *" required></textarea>
                </div>
                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevDynamic()">Previous</button>
                    <button type="button" class="long-btn" onclick="nextDynamic()">Next</button>
                </div>
            </div>

            <div class="form-step" id="stepFinal">
                <div class="inputs">
                    <p>üéâ You're almost done!</p>
                    <p>Join our official WhatsApp community for updates & coordination:</p>

                    <a href="https://malangbvp.info/üîî" target="_blank" class="long-btn"
                        style="position: relative; display: flex; flex-direction: row;">
                        <img src="https://raw.githubusercontent.com/MalangBvp/media/refs/heads/main/images/whatsapp.png"
                            style="height:20px; display: inline-flex; margin-right: 10px;">
                        Join WhatsApp Community
                    </a><br>
                    <div class="checks">
                        <div class="checkbox-group">
                            <input type="checkbox" id="joined_wa" name="joined_wa" />
                            I have joined the WhatsApp community *
                            <label for="joined_wa">Yes
                            </label>
                        </div>
                    </div>


                    <p style="margin-top:10px">
                        ‚ö†Ô∏è Make sure all details are correct before registering.
                    </p>
                </div>

                <div class="btn-group">
                    <button type="button" class="long-btn" onclick="prevDynamic()">Previous</button>
                    <button type="submit" class="long-btn" id="submit">Register</button>
                </div>
            </div>


        </form>


    </section>
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <img id="modal-image" />
        </div>
    </div>
    <script src="../scripts/common.js"></script>
    <script src="../scripts/authentication.js"></script>
    <script>
        // ----------------------------
        // STATE
        // ----------------------------
        let flow = []
        let flowIndex = 0
        const STORAGE_KEY = "malang_fe_register"

        // ----------------------------
        // PROGRESS BAR
        // ----------------------------
        function updateProgress() {
            const bar = document.getElementById("progressBar")
            if (!bar || !flow.length) return
            const percent = ((flowIndex + 1) / flow.length) * 100
            bar.style.width = percent + "%"
        }

        // ----------------------------
        // SHOW STEP
        // ----------------------------
        function showStep(step) {
            document.querySelectorAll(".form-step").forEach(s => {
                s.classList.remove("active");

                // disable inputs in hidden steps
                s.querySelectorAll("input, select, textarea")
                    .forEach(el => el.disabled = true);
            });

            const el = document.getElementById(`step${step}`);
            if (!el) return;

            el.classList.add("active");

            // enable inputs in active step
            el.querySelectorAll("input, select, textarea")
                .forEach(elm => elm.disabled = false);

            updateProgress();
        }

        // ----------------------------
        // VALIDATION
        // ----------------------------
        function validateStep(step) {
            let valid = true

            const required = {
                1: ["competition"],
                2: ["category"],
                3: [
                    "poc_name", "poc_gender", "poc_dob", "poc_phone",
                    "poc_email", "poc_college"
                ],
                4: [
                    "m2_name", "m2_gender", "m2_dob", "m2_phone",
                    "m2_email", "m2_college"
                ],
                5: ["group_members"],
                6: ["joined_wa"]
            }

            if (required[step]) {
                required[step].forEach(id => {
                    const el = document.getElementById(id)
                    if (!el || !el.value.trim()) valid = false
                })
            }

            // STEP 1: Terms & Conditions
            if (step === 1) {
                const tc = document.getElementById("agree_tc")
                if (!tc || !tc.checked) valid = false
            }

            // STEP 5: Group size
            if (step === 5) {
                if (
                    document.querySelectorAll("input[name='group_size']:checked").length === 0
                ) valid = false
            }

            // FINAL STEP: WhatsApp joined
            if (step === "Final") {
                const wa = document.getElementById("joined_wa")
                if (!wa || !wa.checked) valid = false
            }

            if (!valid) {
                showAlert(
                    "‚ö†Ô∏è",
                    "Please complete all required confirmations before continuing.",
                    [{ text: "OK" }]
                )
            }

            return valid
        }

        // ----------------------------
        // BUILD FLOW
        // ----------------------------
        function buildFlow() {
            const comp = competition.value
            const cat = category.value

            flow = [1, 2, 3]

            if (cat === "duet") flow.push(4)
            if (cat === "group" && comp === "fashion") flow.push(5)

            flow.push("Final")

            flowIndex = 2
            showStep(flow[flowIndex])
        }

        // ----------------------------
        // NAVIGATION
        // ----------------------------
        function nextStep(step) {
            if (validateStep(step)) showStep(step + 1)
        }
        function prevStep(step) { showStep(step - 1); }

        function nextDynamic() {
            if (document.getElementById("step2").classList.contains("active")) {
                if (!validateStep(2)) return
                buildFlow()
                return
            }

            if (!validateStep(flow[flowIndex])) return

            flowIndex++
            showStep(flow[flowIndex])
        }

        function prevDynamic() {
            if (flowIndex > 0) {
                flowIndex--
                showStep(flow[flowIndex])
            }
        }

        // ----------------------------
        // DISABLE GROUP FOR COSPLAY
        // ----------------------------
        competition.addEventListener("change", e => {
            const g = [...category.options].find(o => o.value === "group")
            if (g) g.disabled = e.target.value === "cosplay"
        })

        // ----------------------------
        // AUTOSAVE (EVERY INPUT)
        // ----------------------------
        const form = document.getElementById("feForm")

        function saveForm() {
            const data = {}
            new FormData(form).forEach((v, k) => data[k] = v)
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
        }

        function restoreForm() {
            const saved = localStorage.getItem(STORAGE_KEY)
            if (!saved) return

            const data = JSON.parse(saved)
            Object.keys(data).forEach(k => {
                const el = form.elements[k]
                if (!el) return

                if (el.type === "checkbox") {
                    el.checked = true
                } else {
                    el.value = data[k]
                }
            })
        }

        form.addEventListener("input", saveForm)
        window.addEventListener("load", restoreForm)

        // ----------------------------
        // SINGLE SELECT CHECKBOX GROUPS
        // ----------------------------
        document.querySelectorAll(".checkbox-group").forEach((group) => {
            const checkboxes = group.querySelectorAll("input[type='checkbox']");
            checkboxes.forEach((box) => {
                box.addEventListener("change", () => {
                    if (box.checked) {
                        checkboxes.forEach((other) => {
                            if (other !== box) other.checked = false;
                        });
                    }
                });
            });
        });
        // ----------------------------
        // FORM SUBMIT (UNCHANGED + CLEAR STORAGE)
        // ----------------------------
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!validateStep("Final")) {
                showAlert(
                    "‚ö†Ô∏è",
                    "Please join our WhatsApp group before continuing.",
                    [{ text: "OK" }]
                )
                return Promise.reject("Validation failed");
            }

            const url = "https://script.google.com/macros/s/AKfycbz1wxjL0QHfsmL7qbuqPby6mTYrWYpJmcbgFiDUpZq-LkgNpM_uf1M8HgcLajB6LYL6/exec";

            const form = document.getElementById("feForm");

            const disabled = form.querySelectorAll(":disabled");
            disabled.forEach(el => el.disabled = false);

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            disabled.forEach(el => el.disabled = true);

            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: "data=" + encodeURIComponent(JSON.stringify(data))
                });

                const result = await res.json();
                console.log(result); // debug

                if (!result || result.status !== "success") {
                    showAlert(
                        "‚ùå Error",
                        "Submission failed. Please try again.",
                        [{ text: "OK" }]
                    );
                    return;
                }

                localStorage.removeItem(STORAGE_KEY);

                showAlert(
                    "Registered!",
                    "Thank you for registering! üéâ\n\nYou will receive your Participation ID and a confirmation email shortly.",
                    [{ text: "Awesome!" }]
                );

                confetti();
                form.reset();
                showStep(1);

            } catch (err) {
                console.error(err);

                showAlert(
                    "‚ùå Error",
                    "Registration failed. Please try again.",
                    [{ text: "OK" }]
                );
            }
        }

        (function () {
            function rand(min, max) { return Math.random() * (max - min) + min; }

            const COLORS = [
                "#ff004f", "#ff7a00", "#ffd400", "#00e676", "#00b0ff", "#7c4dff",
                "#ff1744", "#ffea00", "#00e5ff", "#69f0ae", "#b388ff", "#ff80ab"
            ];

            // Public API
            window.confetti = function confetti(opts = {}) {
                const {
                    particleCount = 220,
                    scalar = 1,
                    gravity = 0.33,
                    drift = 0.03,
                    decay = 0.007,     // higher = faster fade
                    spread = 70,       // degrees
                    angle = -90,       // -90 = straight up
                    origin = { x: 0.5, y: 0.7 }, // normalized viewport
                    shapes = ["square", "circle", "triangle"]
                } = opts;

                // Canvas setup
                const dpr = Math.min(window.devicePixelRatio || 1, 2);
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.style.cssText = "position:fixed;inset:0;pointer-events:none;z-index:999999";
                document.body.appendChild(canvas);

                function resize() {
                    canvas.width = innerWidth * dpr;
                    canvas.height = innerHeight * dpr;
                    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                }
                resize();
                addEventListener("resize", resize);

                // Particle factory
                const angleRad = (angle * Math.PI) / 180;
                const spreadRad = (spread * Math.PI) / 180;
                const ox = innerWidth * origin.x;
                const oy = innerHeight * origin.y;

                const particles = [];
                for (let i = 0; i < particleCount; i++) {
                    const t = angleRad + rand(-spreadRad / 2, spreadRad / 2);
                    const speed = rand(6, 12) * scalar;
                    particles.push({
                        x: ox, y: oy,
                        vx: Math.cos(t) * speed + rand(-1, 1),
                        vy: Math.sin(t) * speed + rand(-1, 1),
                        w: rand(6, 12) * scalar,
                        h: rand(6, 12) * scalar,
                        r: rand(0, Math.PI * 2),
                        rv: rand(-0.2, 0.2),
                        color: COLORS[(Math.random() * COLORS.length) | 0],
                        shape: shapes[(Math.random() * shapes.length) | 0],
                        alpha: 1,
                        life: rand(220, 340)
                    });
                }

                let raf;
                function drawShape(p) {
                    ctx.fillStyle = p.color;
                    switch (p.shape) {
                        case "circle":
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.w * 0.6, 0, Math.PI * 2);
                            ctx.fill();
                            break;
                        case "triangle":
                            ctx.beginPath();
                            ctx.moveTo(p.x + Math.cos(p.r) * p.w, p.y + Math.sin(p.r) * p.h);
                            ctx.lineTo(p.x + Math.cos(p.r + 2.09) * p.w, p.y + Math.sin(p.r + 2.09) * p.h);
                            ctx.lineTo(p.x + Math.cos(p.r + 4.18) * p.w, p.y + Math.sin(p.r + 4.18) * p.h);
                            ctx.closePath();
                            ctx.fill();
                            break;
                        default: // square/rect
                            ctx.save();
                            ctx.translate(p.x, p.y);
                            ctx.rotate(p.r);
                            ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                            ctx.restore();
                    }
                }

                function frame() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    let alive = 0;

                    for (const p of particles) {
                        p.x += p.vx + drift * (Math.random() - 0.5) * 20;
                        p.y += p.vy += gravity; // gravity accelerates downward
                        p.r += p.rv;
                        p.life--;
                        p.alpha = Math.max(0, p.alpha - decay);

                        if (p.alpha > 0 && p.life > 0 && p.y < innerHeight + 40) {
                            ctx.globalAlpha = p.alpha;
                            drawShape(p);
                            ctx.globalAlpha = 1;
                            alive++;
                        }
                    }

                    if (alive > 0) {
                        raf = requestAnimationFrame(frame);
                    } else {
                        cleanup();
                    }
                }

                function cleanup() {
                    cancelAnimationFrame(raf);
                    removeEventListener("resize", resize);
                    canvas.remove();
                }

                raf = requestAnimationFrame(frame);

                // Return a tiny controller in case you want to kill early
                return { stop: cleanup, canvas };
            };
        })();


        function toBase64(file) {
            return new Promise((res, rej) => {
                const r = new FileReader()
                r.readAsDataURL(file)
                r.onload = () => res(r.result.split(",")[1])
                r.onerror = rej
            })
        }
    </script>

</body>
