<head>
    <title>Malang | Redirector</title>
    <link rel="stylesheet" href="../styles/common.css">
    <link rel="stylesheet" href="../styles/authentication.css">
</head>

<body>
    <h3 class="protected">You must be signed in to view this page.</h3>
    <section id="authentication" class="restricted">
        <canvas id="gradientCanvas"></canvas>
        <form id="redirectorForm">
            <h3>Customise URL</h3>
            <input type="url" id="long" placeholder="URL" required />
            <input type="text" id="slug" placeholder="slug" required />
            Custom URL will be:<br><a href="" class="url" target="_blank"><span id="baseURL"></span><span
                    id="url">slug</span></a>
            <button type="submit" class="long-btn" id="submit">Create</button>
            <p id="msg"></p>
            <hr>
            <button class="long-btn" onclick="parent.loadPage('/src/pages/redirects.html')">View Redirects</button>
        </form>
    </section>
    <script src="../scripts/common.js"></script>
    <script src="../scripts/authentication.js"></script>
    <script>
        const baseURL = document.getElementById('baseURL');
        const slug = document.getElementById('slug');
        const long = document.getElementById('long');
        const urlSpan = document.getElementById('url');
        const urlLink = document.querySelector('a.url');
        const form = document.getElementById('redirectorForm');

        const baseOrigin = window.location.origin; // dynamic base URL

        baseURL.textContent = `${baseOrigin}/`;

        // Update preview
        function updateURL() {
            const base = long.value.trim() || `${baseOrigin}/`;
            const post = slug.value.trim() || '';
            urlSpan.textContent = post || 'slug';
            urlLink.href = base + post;
        }

        // Listen to both inputs
        [slug, long].forEach(el => el.addEventListener('input', updateURL));
        updateURL();
        form.addEventListener('submit', async e => {
            e.preventDefault();

            const longValue = long.value.trim();
            const slugValue = slug.value.trim();

            try {

                const r = await fetch("/submit", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        longUrl: longValue,
                        slug: slugValue
                    })
                });

                if (r.ok) {
                    showAlert(
                        "Requested!",
                        "GitHub Action triggered! A pull request will be created to update the redirector.",
                        [
                            { text: "OK" },
                            { text: "View Redirects", onClick: () => parent.loadPage('/src/pages/redirects.html') }
                        ]
                    );
                } else {
                    const errorText = await r.text();
                    showAlert("Error", `Failed: ${r.status} ${r.statusText}\n${errorText}`, [
                        { text: "OK" }
                    ]);
                }
            } catch (err) {
                showAlert("Error", "Something went wrong: " + err.message, [
                    { text: "OK" }
                ]);
            }
        });

    </script>
</body>