<head>
    <title>Malang | Account</title>
    <link rel="stylesheet" href="../styles/common.css">
    <link rel="stylesheet" href="../styles/authentication.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script type="module">import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
        import {
            getAuth,
            GoogleAuthProvider,
            GithubAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            linkWithCredential
        } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        // ---------------------------
        // Firebase Initialization
        // ---------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyD20pmHMSjDirK1CFEz1EIrUJWwqbVLev4",
            authDomain: "malang-auth.firebaseapp.com",
            projectId: "malang-auth",
            storageBucket: "malang-auth.firebasestorage.app",
            messagingSenderId: "522245850115",
            appId: "1:522245850115:web:f8a69e1e021222fa997a36",
            measurementId: "G-GHFQ1YG8WZ"
        };

        const app = initializeApp(firebaseConfig);
        getAnalytics(app);
        const auth = getAuth(app);

        // ---------------------------
        // Providers (Expandable)
        // ---------------------------
        const providers = {
            google: new GoogleAuthProvider(),
            github: (() => {
                const p = new GithubAuthProvider();
                p.addScope("user:email");
                return p;
            })()
        };

        // ---------------------------
        // Allowed Email List
        // ---------------------------
        let allowedEmails = [];
        fetch("/resrc/data/member-emails.json")
            .then(res => res.json())
            .then(data => allowedEmails = data);

        // --------------------------------
        // Multi-provider linking support
        // --------------------------------
        let pendingCred = null;
        let pendingEmail = null;

        // ---------------------------
        // UI Update
        // ---------------------------

        function updateUI(user) {
            const status = document.getElementById("status");
            const profilePic = window.parent.document.getElementById("profilePic");

            if (user && allowedEmails.includes(user.email)) {
                status.innerText = `Hey ${user.displayName}! ðŸ‘‹`;
                profilePic.src = user.photoURL || "/resrc/images/icons/user.png";
                profilePic.classList.add("profile-pic");
                localStorage.setItem("loggedIn", "true");
            } else {
                status.innerText = user ? "Unauthorised Access Attempt." : "Authentication Required.";
                profilePic.src = "/resrc/images/icons/user.png";
                profilePic.classList.remove("profile-pic");
                localStorage.setItem("loggedIn", "false");
            }

            toggleRestricted();
        }

        // ---------------------------
        // Generic Login Function
        // ---------------------------

        async function loginWith(providerName) {
            const provider = providers[providerName];
            if (!provider) {
                showAlert("Unsupported Provider", "This login option is not configured.", [{ text: "OK" }]);
                return;
            }

            try {
                const { user } = await signInWithPopup(auth, provider);

                if (!user.email) {
                    showAlert("Email Private", "Your GitHub email is hidden. Please make it public or use Google login.", [{ text: "OK" }]);
                    await signOut(auth);
                    return;
                }

                if (!allowedEmails.includes(user.email)) {
                    vibrate(200);
                    showAlert("Unauthorised Access Attempt.", "Login restricted: Membership with Malang is required.", [{ text: "OK" }]);
                    await signOut(auth);
                } else {
                    vibrate(50);
                    showAlert("Login successful", "", [{ text: "Proceed" }]);
                }

                updateUI(user);

            } catch (error) {

                // ----------------------------------------
                // MULTI-PROVIDER ACCOUNT LINKING HANDLING
                // ----------------------------------------
                if (error.code === "auth/account-exists-with-different-credential") {
                    pendingCred = error.credential;
                    pendingEmail = error.customData?.email;

                    showAlert(
                        "Account already exists",
                        "Please sign in via the provider you used earlier.",
                        [{ text: "OK" }]
                    );

                    return; // Stop normal flow
                }

                vibrate(50);
                showAlert("Login failed.", error.message || error, [{ text: "OK" }]);
            }
        }

        // ---------------------------
        // Automatic linking after relogin
        // ---------------------------
        onAuthStateChanged(auth, async (user) => {
            if (user && pendingCred && user.email === pendingEmail) {
                try {
                    await linkWithCredential(user, pendingCred);
                    pendingCred = null;
                    pendingEmail = null;

                    showAlert("Accounts Linked", "You can now log in using multiple providers.", [{ text: "OK" }]);
                } catch (linkErr) {
                    showAlert("Link Failed", linkErr.message, [{ text: "OK" }]);
                }
            }

            updateUI(user);
        });

        // ---------------------------
        // Logout
        // ---------------------------
        async function logout() {
            await signOut(auth);
            updateUI(null);
            showAlert("Logged Out", "You've been logged out.", [{ text: "Close" }]);
        }

        // ---------------------------
        // Expose Functions Globally
        // ---------------------------
        window.login = provider => loginWith(provider);
        window.logout = logout;

    </script>
</head>

<body>
    <section>
        <canvas id="gradientCanvas"></canvas>
        <div id="loginForm">
            <h3 id="status" style="margin-bottom: 10px;">Authentication Required.</h3>
            <div class="restricted">
                <p>You can now access the following pages:</p>
                <a class="long-btn" href="/src/pages/tshirt.html">T-Shirt Form <span id="info" class="g">Open</span></a>
                <a class="long-btn" href="/src/pages/claims.html">Claims</a>
                <a class="long-btn" href='/index.html?page=media'>Media Kit</a>
                <a class="long-btn" href="/src/pages/authentication.html?page=redirector">Redirector<span id="info"
                        class="r">Auth</span></a>
                <a class="long-btn" href='/src/pages/documentation.html'>Site Docs</a>
                <a class="long-btn" href="/src/pages/authentication.html?page=treasury">Treasury<span id="info"
                        class="r">Auth</span></a>
                <a class="long-btn" href="/index.html?page=qr">QR Code Generator</a>
                <hr>
            </div>
            <button class="long-btn loginBtn" onclick="login('google')" style="position: relative;">
                <img src="/resrc/images/icons/google.png" style="height:25px; position:absolute; left:10px; top:6px;">
                <p style="padding-left:25px;">Log in with Google</p>
            </button>

            <button class="long-btn loginBtn" onclick="login('github')" style="position: relative;">
                <img src="https://raw.githubusercontent.com/MalangBvp/media/refs/heads/main/images/github.png"
                    style="height:25px; position:absolute; left:10px; top:6px; filter: invert(1);">
                <p style="padding-left:25px;">Log in with GitHub</p>
            </button>

            <button id="logoutBtn" class="long-btn" onclick="logout()">Log out</button>
        </div>
    </section>
    <script src="../scripts/common.js"></script>
    <script src="../scripts/authentication.js"></script>
</body>