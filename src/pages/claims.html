<head>
    <title>Malang | Claims</title>
    <link rel="stylesheet" href="../styles/common.css">
    <link rel="stylesheet" href="../styles/authentication.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/ldrs/dist/auto/ring2.js"></script>
</head>

<body>
    <div id="loader">
        <l-ring-2 size="18" stroke="2" stroke-length="0.25" bg-opacity="0.1" speed="0.8"
            color="white"></l-ring-2>&nbsp;&nbsp;Authorizing...
    </div>
    <h3 class="protected">You must be signed in to view this page.</h3>
    <section class="restricted">
        <canvas id="gradientCanvas"></canvas>
        <form id="billForm">
            <h3>Claim your bills</h3>
            <input id="name" type="text" name="name" placeholder="Full Name" required>
            <input id="amount" type="number" name="amount" placeholder="Amount" required>
            <label for="file" style="text-align: left; margin: 10px 0 5px 0;">Bill Attachment *</label>
            <input type="file" id="file" name="file" accept="image/*,.pdf" required>

            <div id="failure" style="color: red; opacity: 0;">.</div>
            <button id="claim" type="submit" class="long-btn"
                onclick="handleButtonAction('claim', 'Claiming' , 'Claimed' , () => claimBill())">Claim</button>
        </form>

    </section>
    <script src="../scripts/common.js"></script>
    <script src="../scripts/authentication.js"></script>
    <script>
        const failureDiv = document.getElementById("failure");
        async function claimBill() {
            return new Promise((resolve, reject) => {
                const nameField = document.getElementById("name");
                const amountField = document.getElementById("amount");
                const fileField = document.getElementById("file");

                const name = nameField.value.trim();
                const amount = parseFloat(amountField.value);
                const file = fileField.files[0];
                const url = "https://script.google.com/macros/s/AKfycbz0axQ4ExEM7sxBQDvAXBFV83zVD6YAea6dxePl84ENXJrwrzLIUSTM9c_56Ej3fsl9/exec";

                // Validation
                if (!name) return reject(showError("Please enter your name."));
                if (!amount || amount <= 0) return reject(showError("Amount must be greater than 0."));
                if (!file) return reject(showError("Please attach your bill."));

                const reader = new FileReader();
                reader.onloadend = async function () {
                    try {
                        const base64Data = reader.result.split(',')[1];
                        const data = new URLSearchParams();
                        data.append("name", name);
                        data.append("amount", amount);
                        data.append("filename", file.name);
                        data.append("mimeType", file.type);
                        data.append("file", base64Data);
                        data.append("status", "Pending");  // ✅ Add status here

                        const res = await fetch(url, { method: "POST", body: data });
                        const json = await res.json();

                        if (json.status === "success") {
                            showAlert("Claimed.", "Your request will be reviewed soon.", [{ text: "OK" }]);
                            resolve();
                        } else {
                            reject(showError("❌ Error: " + json.message));
                        }
                    } catch (err) {
                        console.error(err);
                        reject(showError("Something went wrong while submitting."));
                    }
                };
                reader.readAsDataURL(file);
            });

            function showError(msg) {
                failureDiv.textContent = msg;
                failureDiv.style.opacity = 1;
                setTimeout(() => failureDiv.style.opacity = 0, 3000);
            }
        }
    </script>

</body>