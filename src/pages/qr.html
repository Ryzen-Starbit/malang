<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Malang QR Generator</title>
  <link rel="stylesheet" href="../styles/common.css">
  <link rel="stylesheet" href="../styles/authentication.css">
  <style>
    #qrForm label {
      text-align: left;
    }

    .logoPick {
      width: 30px;
      height: 30px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      object-fit: contain;
      margin-bottom: 10px;
    }

    .logoPick.active {
      border-color: #b4b4b4;
    }

    .inline-check {
      display: inline-flex;
      align-items: center;
      text-align: left;
      justify-content:left;
      gap: 8px;
      cursor: pointer;
      margin: 10px 0;
    }

    .inline-check p {
      margin: 0;
      min-width: max-content;
    }

    .inline-check input[type="checkbox"] {
      margin: 0;
      width: 20px;
      margin-top: 3px;
    }

    #qr{
      border: 1px solid var(--border-color);
      border-radius: 7px;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <section id="qrSection">
    <canvas id="gradientCanvas"></canvas>
    <form id="qrForm">
      <h3>QR Generator</h3>

      <input id="URL" type="text" placeholder="Enter URL">

      <label class="inline-check">Foreground
        <input type="color" id="color" value="#000000">
      </label>
      <label class="inline-check">
        <input type="checkbox" id="useGradient"> Gradient Foreground
      </label>

      <div id="gradientOptions" style="display:none">
        <label class="inline-check">Color 1
          <input type="color" id="gColor1" value="#000000">
        </label>

        <label class="inline-check">Color 2
          <input type="color" id="gColor2" value="#ffd700">
        </label>

        <select id="gType">
          <option value="linear">Linear</option>
          <option value="radial">Radial</option>
        </select>
      </div>

      <label class="inline-check">Background
        <input type="color" id="bgColor" value="#ffffff"></label>
      <label class="inline-check">
        <input type="checkbox" id="transparentBg"> Transparent Background
      </label>

      <select id="qrStyle">
        <option value="QR Style" selected disabled>QR Style</option>
        <option value="square">Square</option>
        <option value="dots">Dots</option>
        <option value="rounded">Rounded</option>
        <option value="extra-rounded">Extra Rounded</option>
        <option value="classy">Classy</option>
      </select>

      <hr>

      <label class="inline-check">
        <input type="checkbox" id="useLogo"> Add Logo
      </label>

      <div id="logoOptions" style="display:none">
        <label class="inline-check"><p>Choose Logo:</p>
          <div style="display:flex;gap:7px">
            <img class="logoPick" src="/resrc/images/icons/malang-black.jpg">
            <img class="logoPick" src="/resrc/images/icons/malang.png">
            <img class="logoPick" src="/resrc/images/icons/malang.webp">
            <img class="logoPick" src="/resrc/images/icons/malang.ico">
          </div>
        </label>
        <input type="file" id="logoUpload" accept="image/*">

        <label class="inline-check"><p>Logo Size:</p>
        <input type="range" id="logoSize" min="0.1" max="0.4" step="0.05" value="0.25"></label>
      </div>
      <button id="create" type="button" class="long-btn">Create QR</button>

      <button id="download" type="button" class="long-btn">Download QR</button>

      <div id="qr">QR Code appears here.</div>
    </form>

  </section>
  <script src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
  <script src="../scripts/common.js"></script>
  <script src="../scripts/authentication.js"></script>
  <script>
    (() => {
      const qrDiv = document.getElementById("qr")

      const urlInput = document.getElementById("URL")
      const colorInput = document.getElementById("color")
      const bgInput = document.getElementById("bgColor")
      const styleInput = document.getElementById("qrStyle")
      const transparentBg = document.getElementById("transparentBg")
      const useLogo = document.getElementById("useLogo")
      const logoSize = document.getElementById("logoSize")
      const useGradient = document.getElementById("useGradient")
      const gColor1 = document.getElementById("gColor1")
      const gColor2 = document.getElementById("gColor2")
      const gType = document.getElementById("gType")
      const gradientOptions = document.getElementById("gradientOptions")

      const createBtn = document.getElementById("create")
      const downloadBtn = document.getElementById("download")

      let qr = null
      let logoSrc = ""

      const buildQR = () => {
        const url = urlInput.value.trim()
        if (!url) {
          showAlert("⚠️", "Please enter a URL.");
          return
        }

        const bg = transparentBg.checked ? "transparent" : bgInput.value
        const dotsOptions = useGradient.checked
          ? {
            type: styleInput.value,
            gradient: {
              type: gType.value,
              rotation: 0,
              colorStops: [
                { offset: 0, color: gColor1.value },
                { offset: 1, color: gColor2.value }
              ]
            }
          }
          : {
            color: colorInput.value,
            type: styleInput.value
          }

        qrDiv.innerHTML = ""

        qr = new QRCodeStyling({
          width: 260,
          height: 260,
          data: url,
          image: useLogo.checked ? logoSrc : "",
          dotsOptions: dotsOptions,
          backgroundOptions: {
            color: bg
          },
          imageOptions: {
            crossOrigin: "anonymous",
            imageSize: Number(logoSize.value),
            margin: 5
          }
        })

        qr.append(qrDiv)
      }

      createBtn.onclick = buildQR

        ;[
          urlInput,
          colorInput,
          bgInput,
          styleInput,
          transparentBg,
          useLogo,
          logoSize,
          gColor1,
          gColor2,
          gType
        ].forEach(el => el.addEventListener("input", () => qr && buildQR()))

      useLogo.onchange = () => {
        logoOptions.style.display = useLogo.checked ? "block" : "none"
        qr && buildQR()
      }
      useGradient.onchange = () => {
        gradientOptions.style.display = useGradient.checked ? "block" : "none"
        qr && buildQR()
      }


      document.querySelectorAll(".logoPick").forEach(img => {
        img.onclick = () => {
          document.querySelectorAll(".logoPick").forEach(i => i.classList.remove("active"))
          img.classList.add("active")
          logoSrc = img.src
          qr && buildQR()
        }
      })

      logoUpload.onchange = e => {
        const file = e.target.files[0]
        if (!file) return
        const r = new FileReader()
        r.onload = () => {
          logoSrc = r.result
          qr && buildQR()
        }
        r.readAsDataURL(file)
      }

      downloadBtn.onclick = () => {
        if (!qr) {
          showAlert("⚠️", "Please create a QR code first.");
          return
        }
        qr.download({ name: "malang-qr", extension: "png" })
      }
    })()
  </script>

</body>

</html>